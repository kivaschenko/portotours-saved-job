{% extends "base.html" %}
{% load static %}
{% block title_suffix %}
    Get the best Portugal experiences
{% endblock title_suffix %}

{% block meta_tags %}
    <meta name="description" content="Experiences list page">
    <meta name="keywords" content="experiences">
{% endblock meta_tags %}

{% block content %}

    <section class="experience-list-hero">
        <div class="container">
            <h1 class="experience-list-hero-title">
                Get the best Portugal experiences
                <span>with</span>
                <img src="{% static 'icons/main-logo.svg' %}" alt="Destination logo">
            </h1>
            <div class="experience-list-hero-calendar">
                <form id="experience-search-form" action="{% url 'experience-list' lang=current_language %}" method="get">
                    <div class="place-wrapper">
                        <label for="place">
                            Where to?
                        </label>
                        {{ experience_form.place }}
                        {% if experience_form.place.help_text %}
                            <small class="form-text text-muted">{{ experience_form.place.help_text }}</small>
                        {% endif %}
                        {% for error in experience_form.place.errors %}
                            <div class="alert alert-danger" role="alert">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="date-wrapper">
                        <label for="date">
                            When?
                        </label>
                        {{ experience_form.date }}
                        {% if experience_form.date.help_text %}
                            <small class="form-text text-muted">{{ experience_form.date.help_text }}</small>
                        {% endif %}
                        {% for error in experience_form.date.errors %}
                            <div class="alert alert-danger" role="alert">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="button-wrapper">
                        <button type="submit" class="form-btn btn-type-1">
                            <img src="{% static 'icons/search.svg' %}" alt="">
                            Search
                        </button>
                        <!-- <button id="reset-btn" type="reset" class="form-btn btn-type-2">
                            Reset
                        </button> -->
                    </div>

                </form>
            </div>
        </div>
    </section>
    <section class="experience-list">
        <div class="container">
            <div class="title-filter-wrapper">
                <h3 class="experience-list-title">
                    List of experiences
                </h3>
                <div class="filters-wrapper">
                    <div class="filter-wrapper">
                        <p class="experience-filter-title">
                            Type
                        </p>
                        <select name="experience filter" id="tour_type">
                            <option value="all">All</option>
                            <option value="private">Private</option>
                            <option value="group">Group</option>
                        </select>
                    </div>
                    <div class="filter-wrapper">
                        <p class="experience-filter-title">
                            Sort by
                        </p>
                        <select name="experience filter" id="filter_by">
                            <option value="all">All</option>
                            <option value="price_low">Price - Low To High</option>
                            <option value="price_high">Price - High To Low</option>
                            <option value="discount">Discount</option>
                            <option value="hot_deals">Hot deals first</option>
                        </select>
                    </div>
                </div>

            </div>
            <ul class="experiences">
                {% if object_list %}
                    {% for object in object_list %}
                        <li class="experience-list-item">
                            <div class="list-item-img-wrapper">
                                {% if object.parent_experience.is_exclusive %}
                                    <span class="img-label">Popular! Last booked 2 hours ago</span>
                                {% else %}

                                {% endif %}
                                <a target="_blank" class="link" href="{% url 'experience-detail'  lang=object.language.code.lower slug=object.slug %}">
                                    <img src="{% if object.parent_experience.card_image %}
                                    {{ object.parent_experience.card_image.url }}{% else %}{% endif %}" alt="Card image for {{ object.name }}">
                                </a>
                            </div>
                            <div class="experience-list-content-wrapper">
                                {% if object.review_set.count > 0 %} 
                               <div class="rating-wrapper">
                                <img src="{% static 'icons/empty-stars.svg' %}" alt="">
                               </div>
                               {% else %}
                               <div class="rating-wrapper">
                                <img src="{% static 'icons/5-stars-icon.svg' %}" alt="">
                               </div>
                               {% endif %}
                                <a target="_blank" class="link" href="{% url 'experience-detail'  lang=object.language.code.lower slug=object.slug %}">
                                    <h5>
                                        {{ object.name }}
                                    </h5>
                                </a>
                                <div class="discount-banner">
                                    <img src="{% static 'icons/fire-icon.svg' %}" alt="fire icon">
                                    <span>
                                        {{ object.parent_experience.increase_percentage_old_price }}% discount
                                    </span>
                                   
                                </div>

                                <div class="experience-type-list-wrapper">

                                    <ul class="main-info-list">
                                        <li>
                                            Duration: {% if object.duration %}{{ object.duration|safe }}{% else %}{% endif %}
                                        </li>
                                        {% if object.parent_experience.is_private %}
                                            <li>
                                                Private Tour
                                            </li>
                                        {% endif %}
                                        {% if object.parent_experience.skip_the_line %}
                                            <li>
                                                Skip-The-Line
                                            </li>
                                        {% endif %}
                                        {% if object.parent_experience.likely_to_sell_out %}
                                            <li>Likely to sell out</li>
                                        {% endif %}
                                        {% if object.parent_experience.is_hot_deals %}
                                            <li>
                                                Hot Deal
                                            </li>
                                        {% endif %}
                                    </ul>
                                </div>
                                <p class="experience-list-item-text">
                                    {{ object.short_description }}
                                </p>
                                <div class="price-wrapper">
                                    <p class="old-price">
                                        € {{ object.parent_experience.old_price }}
                                    </p>
                                    <p class="new-price">
                                        € {{ object.parent_experience.price }}
                                    </p>
                                </div>
                                
                                <div class="btns-wrapper">
                                    <a target="_blank" href="{% url 'experience-detail'  lang=object.language.code.lower slug=object.slug %}"
                                        class="experience-link-btn btn-type-1">
                                        Book now
                                    </a>
                                    {% if object.parent_experience.free_cancellation %}
                                        <p class="free-cancelation-label">
                                            + free cancellation
                                        </p>
                                    {% endif %}
                                </div>
                                
                            </div>
                        </li>
                    {% endfor %}
                {% endif %}
            </ul>

            <div class="pagination-block">
                {% if is_paginated %}
                    {% if page_obj.has_previous %}
                        <button class="pagination-btn prev">
                            <a href="?page={{ page_obj.previous_page_number }}">
                                <img src="{% static 'icons/pagination-arrow.svg' %}" alt="prev icon" class="orange">
                            </a>
                        </button>
                    {% else %}
                        <button class="pagination-btn prev">
                            <img src="{% static 'icons/pagination-icon-grey.svg' %}" alt="prev icon" class="grey">
                        </button>
                    {% endif %}
                    <ul class="pagination-list">
                        {% for num in page_obj.paginator.page_range %}

                            {% if page_obj.number == num %}
                                <li class="pagination-list-item active">{{ num }}</li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="pagination-list-item"><a class="" href="?page={{ num }}">{{ num }}</a></li>
                            {% endif %}

                        {% endfor %}
                    </ul>
                    {% if page_obj.has_next %}
                        <button class="pagination-btn next">
                            <a href="?page={{ page_obj.next_page_number }}">
                                <img src="{% static 'icons/pagination-arrow.svg' %}" alt="prev icon" class="orange">
                            </a>
                        </button>
                    {% else %}
                        <button class="pagination-btn next">
                            <img src="{% static 'icons/pagination-icon-grey.svg' %}" alt="prev icon" class="grey">
                        </button>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </section>

    <!-- Custom JS import -->
    <script src="{% static 'js/lang_selector_list_page.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // Функция для обновления URL страницы с параметрами
            function updateURL() {
                var urlParams = new URLSearchParams(window.location.search);
                var tourType = document.getElementById('tour_type').value;
                var filterBy = document.getElementById('filter_by').value;

                // Добавляем новые параметры
                urlParams.set('tour_type', tourType);
                urlParams.set('filter_by', filterBy);

                // Обновляем URL с параметрами
                window.history.replaceState(null, null, window.location.pathname + '?' + urlParams.toString());

                // Перезагружаем страницу
                window.location.reload();
            }

            // Добавляем обработчики событий для изменений в теге <select>
            document.getElementById('tour_type').addEventListener('change', updateURL);
            document.getElementById('filter_by').addEventListener('change', updateURL);

            // Проверяем, есть ли уже параметры в URL, если нет, то добавляем по умолчанию
            var urlParams = new URLSearchParams(window.location.search);
            if (!urlParams.has('tour_type') || !urlParams.has('filter_by')) {
                updateURL(); // Если параметры отсутствуют, добавляем их по умолчанию
            } else {
                var tourTypeValue = urlParams.get('tour_type');
                var filterByValue = urlParams.get('filter_by');
                document.getElementById('tour_type').value = tourTypeValue;
                document.getElementById('filter_by').value = filterByValue;
            }


            const resetBtn = document.getElementById('reset-btn');
            if (resetBtn) {
                resetBtn.addEventListener('click', function () {
                    document.getElementById("experience-search-form").reset();
                    window.history.replaceState({}, document.title, window.location.pathname);
                    window.location.reload();
                });
            }
        });
    </script>
{% endblock %}