{% extends 'base.html' %}
{% load static %}
{% block head %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing details | One Day Tours Portugal</title>
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="stylesheet" href="{% static 'stripe/checkout.css' %}"/>
{% endblock head %}

{% block content %}
    <div class="cart">
        <div class="container">
            <div class="cart-steps-wrapper">
                <ul class="cart-steps">
                    <li class="cart-step-item finished">
                        <img src="{% static 'icons/step-active-icon.svg' %}" alt="step" class="active">
                        <img src="{% static 'icons/step-finished-icon.svg' %}" alt="step" class="finished">
                        <p class="step-text body-text-b4">
                            1 Step
                        </p>
                        <p class="body-text-b3 step-title">
                            My Experiences
                        </p>
                    </li>
                    <li class="cart-step-item active">
                        <img src="{% static 'icons/step-disabled-icon.svg' %}" alt="step" class="disabled">
                        <img src="{% static 'icons/step-active-icon.svg' %}" alt="step" class="active">
                        <img src="{% static 'icons/step-finished-icon.svg' %}" alt="step" class="finished">
                        <p class="step-text body-text-b4">
                            2 Step
                        </p>
                        <p class="body-text-b3 step-title">
                            Billing details
                        </p>
                    </li>
                    <li class="cart-step-item">
                        <img src="{% static 'icons/step-disabled-icon.svg' %}" alt="step" class="disabled">
                        <img src="{% static 'icons/step-active-icon.svg' %}" alt="step" class="active">
                        <img src="{% static 'icons/step-finished-icon.svg' %}" alt="step" class="finished">
                        <p class="step-text body-text-b4">
                            3 Step
                        </p>
                        <p class="body-text-b3 step-title">
                            Confirmation
                        </p>
                    </li>
                </ul>
            </div>
            <div class="cart-title-wrapper">
                <h2 class="cart-title">
                    Billing Details
                </h2>

            </div>
            <!-- Display a payment form -->
            <form id="payment-form">
                <div id="link-authentication-element">
                    <!--Stripe.js injects Link Authentication Element-->
                </div>
                <div id="express-checkout-element">
                    <!-- Mount the Express Checkout Element here -->
                </div>
                <div id="address-element">
                    <!--Stripe.js injects the Address Element-->
                </div>
                <button id="submit">
                    <div class="spinner hidden" id="spinner"></div>
                    <span id="button-text">Pay now</span>
                </button>
                <div id="payment-message" class="hidden"></div>
            </form>
        </div>
    </div>


    <!-- Custom JS import -->
    <script>
        const stripe = Stripe('{{ stripe_public_key }}');
        let elements;
        let paymentElement;

        initialize(); // Call initialize function when the page loads
        checkStatus();

        document.querySelector("#payment-form").addEventListener("submit", handleSubmit);

        async function initialize() {
            // Check if the product_ids list is empty
            const queryParams = new URLSearchParams(window.location.search);
            const paymentIntentClientSecret = queryParams.get('payment_intent_client_secret');

            if (paymentIntentClientSecret) {
                // If the payment_intent_client_secret is not present, do not initialize the payment form
                return;
            }

            const response = await fetch("/checkout/", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({product_ids: {{ product_ids }}}),
            });
            const {clientSecret, customerData} = await response.json();
            console.log('clientSecret', clientSecret);
            console.log('customerData', customerData);
            // Access the nested properties of customerData
            const {name, email, phone, address} = customerData;
            const {city, country, line1, line2, postal_code, state} = address;

            // Create Stripe elements
            const appearance = {
                theme: 'flat',
                labels: 'floating',
            };
            elements = stripe.elements({appearance, clientSecret});

            const linkAuthenticationElement = elements.create("linkAuthentication");
            linkAuthenticationElement.mount("#link-authentication-element");

            const options = {
                mode: 'billing',
                fields: {phone: 'always', email: 'always'},
                display: {
                    // name: 'split'
                },
                defaultValues: {
                    name,
                    phone,
                    address
                }
            };
            // Mount the address element
            const addressElement = elements.create("address", options);
            addressElement.mount('#address-element');

            // Mount the Express Checkout element (Apple Pay, Google Pay, and PayPal)
            const expressCheckoutElement = elements.create("payment", {
                wallet: {applePay: 'always', googlePay: 'always'}, // Specify the wallets you want to support
                paymentMethod: {
                    card: null, // This allows users to select other payment methods like Apple Pay, Google Pay, and PayPal
                    billing_details: {
                        name,
                        email,
                        phone,
                    },
                },
            });
            expressCheckoutElement.mount("#express-checkout-element");

        }

        async function handleSubmit(e) {
            e.preventDefault();

            setLoading(true);

            const {error} = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    return_url: `{{ return_url }}`,
                },
            });

            // This point will only be reached if there is an immediate error when
            // confirming the payment. Otherwise, your customer will be redirected to
            // your `return_url`. For some payment methods like iDEAL, your customer will
            // be redirected to an intermediate site first to authorize the payment, then
            // redirected to the `return_url`.
            if (error) {
                showMessage(error.message);
            } else {
                showMessage("An unexpected error occurred.");
            }

            setLoading(false);
        }

        // Fetches the payment intent status after payment submission
        async function checkStatus() {
            const clientSecret = new URLSearchParams(window.location.search).get(
                "payment_intent_client_secret"
            );

            if (!clientSecret) {
                return;
            }

            const {paymentIntent} = await stripe.retrievePaymentIntent(clientSecret);

            switch (paymentIntent.status) {
                case "succeeded":
                    window.location.href = `/confirmation/{{ current_language }}/?payment_intent_id=${paymentIntent.id}`;
                    break;
                case "processing":
                    showMessage("Your payment is processing.");
                    break;
                case "requires_payment_method":
                    showMessage("Your payment was not successful, please try again.");
                    break;
                default:
                    showMessage("Something went wrong.");
                    break;
            }
        }

        // ------- UI helpers -------

        function showMessage(messageText) {
            const messageContainer = document.querySelector("#payment-message");

            messageContainer.classList.remove("hidden");
            messageContainer.textContent = messageText;

            setTimeout(function () {
                messageContainer.classList.add("hidden");
                messageContainer.textContent = "";
            }, 4000);
        }

        // Show a spinner on payment submission
        function setLoading(isLoading) {
            if (isLoading) {
                // Disable the button and show a spinner
                document.querySelector("#submit").disabled = true;
                document.querySelector("#spinner").classList.remove("hidden");
                document.querySelector("#button-text").classList.add("hidden");
            } else {
                document.querySelector("#submit").disabled = false;
                document.querySelector("#spinner").classList.add("hidden");
                document.querySelector("#button-text").classList.remove("hidden");
            }
        }
    </script>
    <!-- For language selector -->
    <script src="{% static 'js/lang_selector_list_page.js' %}"></script>

    <!-- For language selector -->
    <script src="{% static 'js/lang_selector_list_page.js' %}"></script>
{% endblock %}
